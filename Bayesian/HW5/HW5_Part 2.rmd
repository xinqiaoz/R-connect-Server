---
title: "Bayesian HW5"
author: "Kerui Cao"
date: "11/10/2019"
output: pdf_document
---
```{r setup,echo=F}
knitr::opts_chunk$set(echo = T,out.width="0.9\\linewidth",dev="png",fig.align  = 'center',warning = F,message = F,dpi = 500)
pacman::p_load(tidyverse,knitr,arm,foreign,gridExtra,magrittr,dplyr,tidyr,rstan,bayesplot)
```


```{r}
data = data.frame("y" = c(13,52,6, 40, 10, 7, 66, 10, 10, 14, 16, 4,
                         65, 5, 11, 10, 15, 5, 76, 56, 88, 24, 51, 4,
                         40, 8, 18, 5, 16, 50, 40, 1, 36, 5, 10, 91,
                         18, 1, 18, 6, 1, 23, 15, 18, 12, 12, 17, 3))
```

```{r}
y = data$y
mcmc_array <- function (ns, nchains = 1, params) {
  nparams <- length(params)
  array(dim = c(ns, nchains, nparams),
        dimnames = list(iterations = NULL,
                        chains = paste0("chain", 1:nchains),
                        parameters = params))
}

nc = 4
ns = 10000
cs = c("Lambda","Mu","Sigma","Lp__")

la.c = 0
mu.c = mean(y)
si.c = 1
la.sd = 1
mu.sd = sd(y)
si.sd = 1
n = length(y)

sims = mcmc_array(ns,nchains = nc, params = cs)

wi = function(la){
  y = data$y
  if(abs(la)<0.001){
    w = log(y)
  } else{
    w = (y^la-1)/la
  }
  return(w)
}

w.mu = function(la,mu){
  w = wi(la = la)
  re = 0-sum((w-mu)^2)
  return(re)
}

si.n = function(si){
  return(si^(-(n+1)/2))
}
for(j in 1:nc){
  for(i in 1:ns){
    a = runif(1)
    la.s = rnorm(n = 1,mean = la.c,sd = la.sd)
    r = prod(y^(la.c-la.s))*exp(w.mu(la = la.s,mu = mu.c)/(2*si.c)-w.mu(la = la.c,mu = mu.c)/(2*si.c))
    if(r >= a){la.c = la.s}else{la.c = la.c}
    mu.s = rnorm(n = 1,mean = mu.c,sd = mu.sd)
    r = exp(w.mu(la = la.c,mu = mu.s)/(2*si.c)-w.mu(la = la.c,mu = mu.c)/(2*si.c))
    if(r >= a){mu.c = mu.s}else{mu.c = mu.c}
    si.s = rnorm(n = 1,mean = si.c,sd = si.sd)
    r = si.n(si.s)/si.n(si.c)*exp(w.mu(la = la.c,mu = mu.c)/2*(1/si.s-1/si.c))
    if(r >= a){si.c = si.s}else{si.c = si.c}
    lp = 1/sqrt(si.c)*prod(y^la.c*1/(sqrt(2*pi*si.c)))*exp(w.mu(la = la.c,mu = mu.c)/(2*si.c))
    sims[i,j,] = c(la.c,mu.c,si.c,lp)
  }
}

```